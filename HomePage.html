<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="msapplication-tap-highlight" content="no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
		<!--<script type="text/javascript" src="cordova.js"></script>-->
			<script type="text/javascript" src="js/index.js"></script>
		<link rel="stylesheet" href="jquery.mobile-1.4.5.css" />
		<script src="jquery-1.11.2.js"></script>
		<script src="jquery.mobile-1.4.5.js"></script>
        <title>Jobs</title>
    </head>
    <body>
		<div data-role="page">
			<div data-role="header">
				<a href="#" data-icon="" data-theme="b" onclick="LogOut();">LogOut</a>
				<h1>Jobs</h1>
				<a href="tel:2622936283" data-icon="" data-theme="b">Call Dispatch</a>
			</div><!-- /header -->

			<div data-role="main" class="ui-content">		   
				<form>
					<input id="filter-for-listview" placeholder="Type to search..." data-type="search">
				</form>
				<ul id="listOfJobs" data-role="listview" data-inset="true" data-input="#filter-for-listview" data-filter="true">
					<!--<li><a href="Delivery.html">Delivery 1</a></li>
					<li><a href="Delivery2.html">Delivery 2</a></li>-->
				</ul>				
				<hr />							
				<select id="number" name="value you need">
					<option value="moving" selected="selected">Moving</option>  					
					<option value="moving" selected="selected">Stopped</option>  
					<option value="moving" selected="selected">Stuff</option>  
					<option value="moving" selected="selected">Things</option>  
				</select>
					
				<a href="" data-role="button" onclick="SetStatus();">Set Status</a>			
				<a href="" data-role="button" onclick="PostLocation();">Test Send Location</a>
			</div><!-- /content -->

			<!--<div data-role="footer">
			</div> /footer -->

		</div><!-- /page -->			
    </body>
	<script type="text/javascript">				
		//document.addEventListener("deviceready", onDeviceReady, false);				
		onDeviceReady();

		function onDeviceReady() {
			GetAvailableJobs();
			PostLocation
			//window.plugin.notification.local.add({ message: 'Great app!' });
			// Throw an error if no update is received every 30 seconds
			//var options = { timeout: 30000, enableHighAccuracy:true };
			
			//watchID = navigator.geolocation.watchPosition(onSuccessWatch, onErrorWatch, options);
		}
		
		function GetAvailableJobs(){
			$.ajax({
					type: "GET",
					url: "http://standardexpress.azurewebsites.net/api/MobileLoad/" + localStorage.getItem("DriverId"),					
					success: function(data){
										console.log('Got Jobs');
										for(i = 0; i<data.length;i++){											
											var currentLoad = data[i];
											var htmlToAppend = "<li><a href='Delivery.html'>";
											htmlToAppend += "<p class='ui-li-aside ui-li-desc'>" + currentLoad.StatusName + "</p>";
											htmlToAppend += "<h2 class='ui-li-heading'>Load#: " + currentLoad.OrderId + " - " + currentLoad.ShipCo + "</h2>"
											htmlToAppend += "</a></li>";													
											$('#listOfJobs').append(htmlToAppend);
											$('#listOfJobs').listview('refresh');
										}
									},
					fail: function(){alert('error getting jobs from server')}
			});	
		}
		
		function SetStatus(){
				$.ajax({
				  type: "POST",
				  url: "http://standardexpress.azurewebsites.net/api/MobileLocation",
				  data: {lat:position.coords.latitude, lon:position.coords.longitude, driverId:123456},
				  success: alert('successfully posted to server'),
				  fail: alert('error posting to server')
				});	
		}
		
		function PostLocation(){
			navigator.geolocation.getCurrentPosition(GetLocationSuccess, GetLocationError);
		}
		
		function GetLocationSuccess(position) {							
			$.ajax({
				type: "POST",
				url: "http://standardexpress.azurewebsites.net/api/MobileLocation",
				data: {lat:position.coords.latitude, lon:position.coords.longitude, driverId:123456},
				success: function(){console.log('successfully posted to server from PostLocation');alert('successfully sent location');},
				fail: function(){console.log('error posting from PostLocation');alert('error sending location');}
			});		
		}
		
		function GetLocationError(error) {
			alert('code: '    + error.code    + '\n' +
				  'message: ' + error.message + '\n');
				  return "error sdf ssdf sdf sd";
		}
		
		function LogOut(){
			localStorage.clear();
			$.mobile.changePage("index.html", { transition: "slidedown", });
		}
	</script>
</html>
